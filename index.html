<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ¯æ—¥è·Ÿè¯»</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body {
            font-family: -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }
        header { height: 60px; padding: 0 16px; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); display: flex; align-items: center; gap: 12px; }
        .app-logo { font-size: 28px; }
        #book-title { flex: 1; color: #fff; font-weight: 600; font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #article-selector { padding: 8px; border-radius: 8px; border: none; background: rgba(255,255,255,0.9); max-width: 200px; }
        .main-content { flex: 1; padding: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .swiper-container { flex: 1; width: 100%; max-width: 800px; margin: 0 auto; border-radius: 20px; overflow: hidden; background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .swiper { width: 100%; height: 100%; }
        .swiper-slide { height: 100%; display: flex !important; flex-direction: column; }
        .slide-image { height: 55%; background-color: #f5f5f7; background-size: contain; background-position: center; background-repeat: no-repeat; }
        .slide-text { height: 45%; padding: 20px; overflow-y: auto; font-size: 22px; line-height: 1.6; color: #333; }
        .word { padding: 2px; border-radius: 4px; transition: 0.2s; }
        .word.active-word { background: #ffd700; transform: scale(1.1); display: inline-block; font-weight: bold; }
        footer { padding: 12px 16px; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); }
        .controls { max-width: 800px; margin: 0 auto; }
        .btn { width: 100%; height: 50px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; color: #fff; margin-top: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        #btn-play { background: #34C759; } #btn-play.speaking { background: #FF9500; }
        .speed-row { display: flex; align-items: center; color: #fff; gap: 10px; margin-bottom: 5px; }
        #speed-slider { flex: 1; }
        .placeholder-slide { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #888; font-size: 18px; }
        .icon { font-size: 64px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <header>
        <span class="app-logo">ğŸ“š</span>
        <span id="book-title">æ¯æ—¥è·Ÿè¯»</span>
        <select id="article-selector"><option value="">åŠ è½½ä¸­...</option></select>
    </header>
    <div class="main-content">
        <div class="swiper-container"><div class="swiper" id="book-swiper"><div class="swiper-wrapper">
            <div class="swiper-slide"><div class="placeholder-slide"><div class="icon">ğŸ“–</div><p>è¯·ä»å³ä¸Šè§’é€‰æ‹©ç»˜æœ¬</p></div></div>
        </div></div></div>
    </div>
    <footer>
        <div class="controls">
            <div class="speed-row"><span>ğŸ¢</span><input type="range" id="speed-slider" min="0.8" max="1.5" step="0.1" value="1.0"><span>ğŸ‡</span><span id="speed-value">1.0x</span></div>
            <button class="btn" id="btn-play">â–¶ï¸ æ’­æ”¾</button>
        </div>
    </footer>
    <script>
        const selector = document.getElementById('article-selector');
        const bookTitle = document.getElementById('book-title');
        const btnPlay = document.getElementById('btn-play');
        const slider = document.getElementById('speed-slider');
        const speedVal = document.getElementById('speed-value');
        const synth = window.speechSynthesis;
        let swiper, pages=[], idx=0, isPlaying=false, currentFolderPath='';

        slider.oninput = function(){ speedVal.innerText = this.value + 'x'; };

        function initSwiper() {
            if(swiper) swiper.destroy(true, true);
            swiper = new Swiper('#book-swiper', {
                threshold: 5,
                on: { slideChange: () => { idx=swiper.activeIndex; if(isPlaying) stop(); } }
            });
        }
        initSwiper();

        fetch('./lesson/library.json')
            .then(r => r.json())
            .then(data => {
                selector.innerHTML = '<option value="">é€‰æ‹©ç»˜æœ¬...</option>';
                if(data.O) data.O.forEach(b => {
                    let opt = document.createElement('option');
                    opt.value = b.path;
                    opt.textContent = '[O] ' + b.title;
                    opt.dataset.title = b.title;
                    selector.appendChild(opt);
                });
            })
            .catch(e => {
                console.error(e);
                selector.innerHTML = '<option>ä¹¦å•åŠ è½½å¤±è´¥</option>';
            });

        selector.addEventListener('change', async function() {
            const fullPath = this.value;
            if(!fullPath) return;
            
            bookTitle.textContent = this.options[this.selectedIndex].dataset.title;
            stop();

            currentFolderPath = fullPath.replace(/\/story\.md$/, '');
            
            const url = './' + fullPath;
            console.log('[DEBUG] Fetch URL:', url);
            console.log('[DEBUG] Folder Path:', currentFolderPath);

            try {
                const res = await fetch(url);
                if(!res.ok) throw new Error('HTTP ' + res.status);
                const text = await res.text();
                parse(text);
            } catch(e) {
                console.error('[ERROR]', e);
                alert('æ— æ³•åŠ è½½: ' + url);
            }
        });

        function parse(md) {
            pages = md.split(/\n-{3,}\n/).map(p => {
                const imgMatch = p.match(/!\[.*?\]\((.*?)\)/);
                const text = p.replace(/!\[.*?\]\(.*?\)/g, '').replace(/[#*`]/g, '').trim();
                let img = '';
                if(imgMatch) {
                    const imgRelPath = imgMatch[1];
                    img = imgRelPath.startsWith('http') ? imgRelPath : './' + currentFolderPath + '/' + imgRelPath;
                }
                return { img, text };
            }).filter(p => p.img || p.text);

            console.log('[DEBUG] Parsed pages:', pages.length);
            if(pages.length > 0) console.log('[DEBUG] First image:', pages[0].img);

            const html = pages.map((p,i) => `
                <div class="swiper-slide">
                    <div class="slide-image" style="background-image:url('${encodeURI(p.img)}')"></div>
                    <div class="slide-text">${textToSpans(p.text)}</div>
                </div>`).join('');
            
            document.querySelector('.swiper-wrapper').innerHTML = html;
            initSwiper();
            idx=0; swiper.slideTo(0);
        }

        function textToSpans(txt) {
            return txt.split(/\s+/).map((w,i) => `<span class="word" id="w-${i}">${w}</span>`).join(' ');
        }

        function play() {
            if(idx >= pages.length) return stop();
            const text = pages[idx].text;
            if(!text || text.length < 2) { setTimeout(next, 500); return; }

            const u = new SpeechSynthesisUtterance(text);
            u.rate = slider.value;
            u.lang = 'en-US';
            
            let charCount = 0;
            const words = text.split(/\s+/);
            const wordMap = words.map(w => { const s=charCount; charCount+=w.length+1; return {s, e:s+w.length}; });

            u.onboundary = (e) => {
                if(e.name === 'word') {
                    const i = wordMap.findIndex(w => e.charIndex >= w.s && e.charIndex < w.e);
                    if(i!==-1) {
                        document.querySelectorAll('.active-word').forEach(el=>el.classList.remove('active-word'));
                        const el = document.querySelector(`.swiper-slide-active #w-${i}`);
                        if(el) el.classList.add('active-word');
                    }
                }
            };
            u.onend = () => { if(isPlaying) setTimeout(next, 500); };
            synth.cancel(); synth.speak(u);
        }

        function next() {
            if(idx < pages.length-1) { swiper.slideNext(); play(); } else { stop(); }
        }

        function stop() {
            isPlaying = false; synth.cancel();
            btnPlay.innerHTML = 'â–¶ï¸ æ’­æ”¾'; btnPlay.classList.remove('speaking');
            document.querySelectorAll('.active-word').forEach(el=>el.classList.remove('active-word'));
        }

        btnPlay.onclick = () => {
            if(isPlaying) stop(); else { isPlaying=true; btnPlay.innerHTML='â¸ï¸ æš‚åœ'; btnPlay.classList.add('speaking'); play(); }
        };
    </script>
</body>
</html>
